<!DOCTYPE html>
<html>

<head>
    <script src='https://cdn.firebase.com/js/client/1.0.15/firebase.js'></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
    html {
        height: 100%
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0
    }
    #map-canvas {
        height: 100%
    }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxqIv2x3CwElxQH_tnL_qNE-yUaKWfgiw">
    </script>
    <script type="text/javascript">
    var bin_red = 'images/bin_red.png';
    var bin_green = 'images/bin_green.png';
    var bin_yellow = 'images/bin_yellow.png';
    var office_icon = 'images/office.png';

    var startPoint = new google.maps.LatLng(16.451407, 107.5899106);
    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;

    var listMarker = [];
    var listPos = [];

    function initialize() {
        directionsDisplay = new google.maps.DirectionsRenderer({
            suppressMarkers: true
        });
        var hue = new google.maps.LatLng(16.4534777, 107.5769233);
        var mapOptions = {
            center: hue,
            zoom: 14,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
        directionsDisplay.setMap(map);
        var startMarker = new google.maps.Marker({
            position: startPoint,
            map: map,
            title: '\u0043\u00f4\u006e\u0067 \u0074\u0079 \u0110\u00f4 \u0074\u0068\u1ecb \u002d \u0048\u0075\u1ebf',
            animation: google.maps.Animation.DROP,
            icon: office_icon
        });
    }
    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
    <script>
    function getIcon(trash) {
        if (trash < 30)
            return bin_green
        if (trash < 70)
            return bin_yellow
        else
            return bin_red
    }

    function calcRoute() {
        var waypts = [];
        for (var point in listPos) {
            if (listPos.hasOwnProperty(point)) {
                var data = listPos[point];
                if (data.trash >= 70) {
                    waypts.push({
                        location: new google.maps.LatLng(data.lat, data.long),
                        stopover: true
                    });
                }
            }
        }

        if (waypts.length <= 0) {
            directionsDisplay.setMap(null);
            return;
        }

        directionsDisplay.setMap(map);

        var request = {
            origin: startPoint,
            destination: startPoint,
            waypoints: waypts,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        };

        directionsService.route(request, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(response);
            }
        });
    }

    function createMarker(data) {

        var newPoint = new google.maps.LatLng(data.lat, data.long);

        var icon_image = getIcon(data.trash)

        var marker = new google.maps.Marker({
            position: newPoint,
            map: map,
            title: data.name,
            animation: google.maps.Animation.DROP,
            icon: icon_image
        });

        var infowindow = new google.maps.InfoWindow({
            content: '<div id=\'content\'>' + data.trash + '</div>'
        });
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
        });

        return marker;
    }

    var myDataRef = new Firebase('https://incandescent-fire-7887.firebaseio.com/');
    myDataRef.on('child_added', function(snapshot) {
        // alert('adding');
        var data = snapshot.val();
        listPos[data.name] = data;
        listMarker[data.name] = createMarker(data);

        calcRoute();
    });

    myDataRef.on('child_changed', function(snapshot) {
        var data = snapshot.val();
        // alert(data.trash);
        var pos = listPos[data.name];
        var marker = listMarker[data.name];

        if (pos)
            listPos[data.name] = data;

        if (marker) {
            marker.setMap(null)
            marker = null;
            listMarker[data.name] = createMarker(data);
        }

        calcRoute();
    });
    </script>
</head>

<body>
    <div id="map-canvas" />
</body>

</html>
